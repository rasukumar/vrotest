<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item12" object-name="workflow:name=generic" id="a2a250aa-e21d-4be0-adf7-32705524138e" version="0.0.0" api-version="6.0.0" allowed-operations="evf" editor-version="2.0" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Add domain user to local admin group]]></display-name>
  <position y="10.0" x="40.0"/>
  <input>
    <param name="inputProperties" type="Properties"/>
  </input>
  <attrib name="cmd" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[#{##}#]]></value>
  </attrib>
  <attrib name="vmUsername" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="vmPassword" type="SecureString" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="interactiveSession" type="boolean" read-only="false">
    <value encoded="n"><![CDATA[false]]></value>
  </attrib>
  <attrib name="programPath" type="string" read-only="false">
    <value encoded="n"><![CDATA[C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe]]></value>
  </attrib>
  <attrib name="workingDirectory" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="environment" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[#{##}#]]></value>
  </attrib>
  <attrib name="result" type="number" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="wfRunProgramInGuest" type="Workflow" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/Workflow?id='331c7a67-d07f-49a5-b5b6-1cbe5fb994b4'&dunesName='Workflow']]></value>
  </attrib>
  <attrib name="vm" type="VC:VirtualMachine" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="domain" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="user" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="counter" type="number" read-only="false">
    <value encoded="n"><![CDATA[1.0]]></value>
  </attrib>
  <attrib name="boolUser" type="boolean" read-only="false">
    <value encoded="n"><![CDATA[false]]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="100.0" x="760.0"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item7" type="task">
    <display-name><![CDATA[Read from payload]]></display-name>
    <script encoded="false"><![CDATA[
var jsontxt = JSON.stringify(inputProperties, null, 2)
System.log("jsontxt: " +jsontxt)
var json = JSON.parse(jsontxt)
System.log("parsed jsontxt: "+json)
var vmName = json.resourceNames[0]
System.log("vm name: "+vmName)
var ipAddress = json.addresses[0][0]
System.log("IP Address: "+ipAddress)

var custProp = inputProperties.get('customProperties')
user = custProp.get('user')
System.log("Domain user: "+ user)

domain = custProp.get('domain')
System.log("Domain name: "+ domain)

var env = custProp.get('environment')
System.log("Environment: "+ env)
if(env == "P" || env == "R")
    env = "Prod"
else env = "NonProd"

System.log("Environment: "+ env)

// get vm credentials according to prod/nonprod
var configElements = Server.findAllForType("ConfigurationElement","name='vmCredentials'")
var creds = "" 
var attr =  configElements[0].getAttributeWithKey(env)
creds = attr.value

vmUsername =  creds.username
vmPassword = creds.password


vm =  System.getModule("com.vmware.ihis").getVmFromVcenterByName(vmName);]]></script>
    <in-binding>
      <bind name="inputProperties" type="Properties" export-name="inputProperties"/>
    </in-binding>
    <out-binding>
      <bind name="user" type="string" export-name="user"/>
      <bind name="vm" type="VC:VirtualMachine" export-name="vm"/>
      <bind name="domain" type="string" export-name="domain"/>
      <bind name="vmUsername" type="string" export-name="vmUsername"/>
      <bind name="vmPassword" type="SecureString" export-name="vmPassword"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="31.814315040495366" x="200.47778359386655"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item0" type="task">
    <display-name><![CDATA[Run program In Guest]]></display-name>
    <script encoded="false"><![CDATA[
var inputs,currentToken =""

for each(var arg in cmd){
    try{
        System.log("arg: "+arg)
        inputs = new Properties()
        inputs.put("interactiveSession",interactiveSession)
        inputs.put("workingDirectory",workingDirectory)
        inputs.put("environment",environment)
        inputs.put("programPath",programPath)
        inputs.put("vmPassword",vmPassword)
        inputs.put("vmUsername",vmUsername)
        inputs.put("arguments",arg)
        inputs.put("vm",vm)
        currentToken = wfRunProgramInGuest.execute(inputs)
        // System.sleep(15 * 1000)
        System.getModule("com.vmware.ihis").wfState(currentToken);
    }
    catch(e){
        System.log("Workflow failed with error: \n"+e)
    }
}
]]></script>
    <in-binding>
      <bind name="vmUsername" type="string" export-name="vmUsername"/>
      <bind name="vmPassword" type="SecureString" export-name="vmPassword"/>
      <bind name="interactiveSession" type="boolean" export-name="interactiveSession"/>
      <bind name="programPath" type="string" export-name="programPath"/>
      <bind name="workingDirectory" type="string" export-name="workingDirectory"/>
      <bind name="environment" type="Array/string" export-name="environment"/>
      <bind name="wfRunProgramInGuest" type="Workflow" export-name="wfRunProgramInGuest"/>
      <bind name="vm" type="VC:VirtualMachine" export-name="vm"/>
      <bind name="cmd" type="Array/string" export-name="cmd"/>
    </in-binding>
    <out-binding>
      <bind name="result" type="number" export-name="result"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="30.0" x="740.0"/>
  </workflow-item>
  <workflow-item name="item3" out-name="item15" type="task">
    <display-name><![CDATA[Set command]]></display-name>
    <script encoded="false"><![CDATA[
//cmd = "cmd.exe /c 'net localgroup administrators /add "+domain+"\\"+user+"'"

System.log("domain user/s: "+user)

var userArray = ""
var command = ""

if(user != "" && user != null){
    userArray = user.split(",")
    cmd = new Array()

    for each(var usr in userArray){
        usr = usr.trim()
        command = "cmd.exe /c 'net localgroup administrators /add "+usr+" > c:\\useradd.txt'"
        cmd.push(command)
    }

    System.log("Users to add to local admin group: "+cmd)
    boolUSer = true
    System.sleep(150000)
}
else {
    System.log("No users to add to the domain..")
    boolUSer = false
}]]></script>
    <in-binding>
      <bind name="user" type="string" export-name="user"/>
      <bind name="domain" type="string" export-name="domain"/>
    </in-binding>
    <out-binding>
      <bind name="cmd" type="Array/string" export-name="cmd"/>
      <bind name="boolUser" type="boolean" export-name="boolUser"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="30.0" x="498.0"/>
  </workflow-item>
  <workflow-item name="item7" out-name="item3" type="custom-condition" alt-out-name="item8">
    <display-name><![CDATA[Validate tools status]]></display-name>
    <script encoded="false"><![CDATA[System.log("VC VM: "+vm)
System.log("VC VM name: "+vm.name)

var toolStatus = vm.guest.toolsStatus.value;
if(String(toolStatus) == "toolsOk" || (String(toolStatus) == "toolsOld"))
return true;
else
return false; ]]></script>
    <in-binding>
      <bind name="vm" type="VC:VirtualMachine" export-name="vm"/>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="23.21907694525727" x="368.00159311767607"/>
  </workflow-item>
  <workflow-item name="item8" out-name="item10" type="task">
    <display-name><![CDATA[Show message]]></display-name>
    <script encoded="false"><![CDATA[
var errorMessage = "VMware Tools are not running";
System.error("[Error::] "+ errorMessage); ]]></script>
    <in-binding/>
    <out-binding/>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="106.28170052453869" x="388.12800071941354"/>
  </workflow-item>
  <workflow-item name="item10" prototype-id="increase-counter" out-name="item7" content-mode="x" type="task">
    <display-name><![CDATA[Increase counter]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
counter = counter + 1;]]></script>
    <in-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[Item to increase]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[Increased item]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Increment a counter by one.]]></description>
    <position y="106.28170052453869" x="228.12800071941354"/>
  </workflow-item>
  <workflow-item name="item11" type="end" end-mode="0">
    <position y="112.06262357928142" x="140.12640760173744"/>
  </workflow-item>
  <workflow-item name="item12" out-name="item1" type="custom-condition" alt-out-name="item13">
    <display-name><![CDATA[Join to domain?]]></display-name>
    <script encoded="false"><![CDATA[
var custProp = inputProperties.get('customProperties')
var domainJoinYN = custProp.get('domainJoinYN')
System.log("domainJoinYN: "+ domainJoinYN)

return domainJoinYN]]></script>
    <in-binding>
      <bind name="inputProperties" type="Properties" export-name="inputProperties"/>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="12.109538472628635" x="94.00079655883803"/>
  </workflow-item>
  <workflow-item name="item13" out-name="item11" type="task">
    <display-name><![CDATA[Scriptable task]]></display-name>
    <script encoded="false"><![CDATA[
System.log("User opted for not to join the VM to domain.")]]></script>
    <in-binding/>
    <out-binding/>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="71.03131178964071" x="99.06320380086873"/>
  </workflow-item>
  <workflow-item name="item14" type="end" end-mode="0">
    <position y="100.0" x="620.0"/>
  </workflow-item>
  <workflow-item name="item15" out-name="item2" type="custom-condition" alt-out-name="item14">
    <display-name><![CDATA[Decision]]></display-name>
    <script encoded="false"><![CDATA[if(boolUser == true)
    return true
else return false]]></script>
    <in-binding>
      <bind name="boolUser" type="boolean" export-name="boolUser"/>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="20.0" x="600.0"/>
  </workflow-item>
  <presentation/>
</workflow>